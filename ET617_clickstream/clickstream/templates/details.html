{% extends "base.html" %}
{% block content %}
<h1>{{ content.title }}</h1>

<!-- Render text -->
<div id="content-body">
  {{ content.body|safe }}
</div>

{% if content.type == "video" or content.video_url %}
  <video id="player" width="720" controls crossorigin="anonymous">
    <source src="{{ content.video_url }}" type="video/mp4">
    Your browser doesn't support HTML5 video.
  </video>
{% endif %}

{% if quiz %}
  <h2>{{ quiz.content.title }} â€” Quiz</h2>
  <form id="quiz-form" data-quiz-id="{{ quiz.id }}">
    {% for q in quiz.questions %}
      <div class="question" data-qid="{{ q.id }}">
        <p>{{ q.question }}</p>
        {% for choice in q.choices %}
          <label>
            <input type="radio" name="q-{{ q.id }}" value="{{ forloop.counter0 }}">
            {{ choice }}
          </label><br>
        {% endfor %}
      </div>
    {% endfor %}
    <button type="submit">Submit Quiz</button>
  </form>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
/* Tracker code: buffers events and POSTs to /api/events */
(function(){
  const SESSION_KEY = 'learn_session_id';
  function getSessionId(){
    let s = localStorage.getItem(SESSION_KEY);
    if(!s){ s = 'sess_' + Math.random().toString(36).slice(2); localStorage.setItem(SESSION_KEY, s); }
    return s;
  }

  let buffer = [];
  const FLUSH_INTERVAL = 5000;
  const BATCH_SIZE = 10;
  const endpoint = '/api/events/';

  function pushEvent(eventType, props){
    const ev = {
      event_type: eventType,
      session_id: getSessionId(),
      content_id: '{{ content.id }}',
      event_props: Object.assign({
        url: window.location.pathname,
        title: document.title,
        user_agent: navigator.userAgent
      }, props || {})
    };
    buffer.push(ev);
    if(buffer.length >= BATCH_SIZE) flush();
  }

  async function flush(){
    if(buffer.length === 0) return;
    const batch = buffer.splice(0, buffer.length);
    try {
      await fetch(endpoint, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({events: batch})
      });
    } catch(e){
      console.error('Event send failed', e);
      buffer = batch.concat(buffer); // requeue
    }
  }

  setInterval(flush, FLUSH_INTERVAL);

  // Page view
  pushEvent('page_view', {});

  // Click capturing: delegate
  document.addEventListener('click', function(e){
    const el = e.target;
    pushEvent('click', {element: el.tagName, id: el.id || null, classes: el.className || null, x: e.clientX, y: e.clientY, text: el.innerText ? el.innerText.slice(0,80) : ''});
  });

  // Video events
  const player = document.getElementById('player');
  if (player) {
    player.addEventListener('play', ()=> pushEvent('video_play', {current_time: player.currentTime}));
    player.addEventListener('pause', ()=> pushEvent('video_pause', {current_time: player.currentTime}));
    player.addEventListener('seeked', ()=> pushEvent('video_seek', {current_time: player.currentTime}));
    player.addEventListener('ended', ()=> pushEvent('video_ended', {current_time: player.currentTime}));
    player.addEventListener('timeupdate', () => {
      // throttle timeupdate to, say, once per 5s (simple)
      const t = Math.floor(player.currentTime);
      if (t % 5 === 0) pushEvent('video_timeupdate', {current_time: player.currentTime});
    });
  }

  // Quiz submit
  const quizForm = document.getElementById('quiz-form');
  if(quizForm){
    quizForm.addEventListener('submit', async function(e){
      e.preventDefault();
      const quizId = quizForm.dataset.quizId;
      const answers = {};
      const qs = quizForm.querySelectorAll('.question');
      qs.forEach(q => {
        const qid = q.dataset.qid;
        const selected = q.querySelector('input[type=radio]:checked');
        answers[qid] = selected ? selected.value : null;
      });
      // compute score client-side if you want (requires quiz data). We'll just send answers
      pushEvent('quiz_submit', {quiz_id: quizId, answers: answers});
      // Optionally also persist as authoritative quiz attempt
      try {
        const res = await fetch('/api/quiz_attempts/', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({quiz: quizId, answers: answers, score: 0, duration_seconds: 0})
        });
      } catch(err){
        console.error(err);
      }
      alert('Submitted!');
    });
  }

  // send events on unload
  window.addEventListener('beforeunload', function(){
    if (buffer.length === 0) return;
    const payload = JSON.stringify({events: buffer});
    if (navigator.sendBeacon) {
      navigator.sendBeacon(endpoint, payload);
      buffer = [];
    } else {
      // fallback synchronous XHR (deprecated)
      var xhr = new XMLHttpRequest();
      xhr.open('POST', endpoint, false);
      xhr.setRequestHeader('Content-Type', 'application/json');
      try { xhr.send(payload); buffer = []; } catch(e) {}
    }
  });

})();
</script>
{% endblock %}
